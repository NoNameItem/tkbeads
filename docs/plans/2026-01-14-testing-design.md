# Стратегия тестирования tkbeads

## Приоритеты

1. Уверенность в корректности логики
2. Предотвращение регрессий
3. Документация поведения через тесты

## Уровни тестирования

| Уровень | Что проверяем | Инструменты |
|---------|---------------|-------------|
| **Unit** | Data-слой (парсинг JSONL, модели), Store-слой (распределение по колонкам, фильтрация blocked/ready) | pytest, фабрики |
| **Integration** | Сценарии пользователя: навигация, смена статуса, поиск | Textual pilot, временные файлы |
| **Snapshot** | Визуальное отображение: доска, модалки, состояния | pytest-textual-snapshot (SVG) |

## Тестовые данные

- **Фабрики** — для unit-тестов, создание Task с нужными параметрами прямо в тесте
- **Файлы-фикстуры** — для integration/snapshot, готовые .jsonl сценарии

## Покрытие по вертикальным срезам

Каждый срез — самостоятельный релиз с полным покрытием всеми видами тестов.

| Версия | Unit | Integration | Snapshot |
|--------|------|-------------|----------|
| **V1 (MVP)** | loader, models, store (распределение по колонкам) | навигация Tab/стрелки, выход по q | пустая доска, доска с задачами |
| **V2 (Интерактивность)** | store.update_status, loader.save | Enter → модалка → смена статуса → файл обновлён | модалка деталей |
| **V3 (Иерархия)** | построение дерева, определение цепочки предков | сворачивание/разворачивание (Space, ←/→, Ctrl-варианты) | дерево развёрнуто, свёрнуто, ребёнок в другой колонке с цепочкой |
| **V4 (Поиск)** | фильтрация по тексту, поиск по ID | `/` → ввод → фильтр, `g` → переход, `n/N` навигация | доска с активным фильтром (dimmed задачи) |
| **V5 (Live updates)** | watcher детектит изменения | изменение файла извне → UI обновился | — |

## Структура директорий

```
tests/
├── conftest.py              # фабрики и общие фикстуры
├── fixtures/                # .jsonl файлы для integration/snapshot
├── unit/
│   ├── test_models.py
│   ├── test_loader.py
│   └── test_task_store.py
├── integration/
│   └── test_kanban.py
└── snapshots/
    └── test_snapshots.py
```

## Зависимости

```toml
[dependency-groups]
dev = [
    "pytest>=8.0",
    "pytest-textual-snapshot>=1.0",
    # ...
]
```

## Запуск

```bash
pytest                    # все тесты
pytest tests/unit         # только unit
pytest --snapshot-update  # обновить снимки после изменений UI
```

## CI

- Запуск на каждый push/PR
- Порядок: ruff check → ty check → pytest
- Расхождение snapshot — сигнал ревьюеру проверить визуальные изменения
