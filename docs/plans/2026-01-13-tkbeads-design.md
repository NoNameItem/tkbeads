# tkbeads — TUI для Beads Task Tracker

## Обзор

TUI-приложение на Python для работы с [Beads](https://github.com/steveyegge/beads) — распределённым трекером задач для AI-агентов.

**Ключевые решения:**
- Библиотека: Textual
- Интеграция: прямой доступ к `.beads/issues.jsonl`
- Автообновление: file watcher

## Архитектура

```
┌─────────────────────────────────────┐
│           UI Layer (Textual)        │
│  KanbanScreen → TaskDetailModal     │
├─────────────────────────────────────┤
│          State Layer                │
│  TaskStore (reactive state)         │
├─────────────────────────────────────┤
│          Data Layer                 │
│  BeadsLoader + FileWatcher          │
└─────────────────────────────────────┘
```

**Поток данных:**
```
FileWatcher → BeadsLoader → TaskStore → UI обновляется
```

При изменении статуса:
```
UI action → TaskStore.update_status() → BeadsLoader.save() → файл обновлён
```

## Модель данных

```python
@dataclass
class Task:
    id: str              # "bd-a1b2" или "bd-a1b2.1"
    title: str
    status: Status       # open | in_progress | blocked | closed
    priority: int        # 0 = highest
    description: str
    created_at: datetime
    updated_at: datetime
    blockers: list[str]  # ID задач, которые блокируют эту
    parent_id: str | None

class Status(Enum):
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    BLOCKED = "blocked"
    CLOSED = "closed"
```

## Требования к UI

### Kanban Board

```
┌──────────────┬──────────────┬──────────────┬─────────────┐
│   BLOCKED    │    READY     │ IN PROGRESS  │   CLOSED    │
│     (1)      │     (3)      │     (2)      │    (47)     │
├──────────────┼──────────────┼──────────────┼─────────────┤
│  Deploy CI   │ ▼ Setup DB   │   Auth API   │  Init repo  │
│              │     subtask1 │   Frontend   │  Schema     │
│              │     subtask2 │              │  ...        │
│              │   Docs       │              │             │
└──────────────┴──────────────┴──────────────┴─────────────┘
```

**Логика колонок:**
- BLOCKED: `status == open` И есть открытые блокеры
- READY: `status == open` И нет открытых блокеров
- IN PROGRESS: `status == in_progress`
- CLOSED: `status == closed`

### Древовидное отображение задач

Задачи отображаются в виде дерева parent-child:
- Дети отображаются с отступом под родителем
- Иконка `▼/▶` показывает состояние свёрнут/развёрнут
- По умолчанию все узлы развёрнуты

**Дети в других колонках:**
- Дети остаются в колонке согласно своему статусу
- Над ребёнком отображается цепочка его предков приглушённым цветом
- У каждого предка показывается его реальный статус

Пример (ребёнок в IN PROGRESS, родители в других статусах):
```
IN PROGRESS column:
─────────────────────────────────
  [CLOSED] Epic project        ← приглушённый
    [READY] Setup auth         ← приглушённый
      ● JWT implementation     ← текущая задача
─────────────────────────────────
```

**Поведение сворачивания:**
- Сворачивание влияет только на детей в той же колонке
- Потомки в других колонках остаются видимыми со своей цепочкой предков

### Навигация

**Перемещение:**

| Клавиша | Действие |
|---------|----------|
| `Tab` | Следующая колонка (циклично) |
| `Shift+Tab` | Предыдущая колонка (циклично) |
| `↑/↓` | Выбор задачи в колонке |
| `Enter` | Открыть детали задачи |
| `q` | Выход |

**Сворачивание/разворачивание:**

| Клавиша | Действие |
|---------|----------|
| `Space` | Переключить состояние узла |
| `←` | Свернуть узел |
| `→` | Развернуть узел |
| `Ctrl+←` | Свернуть все в колонке |
| `Ctrl+→` | Развернуть все в колонке |
| `Ctrl+Shift+←` | Свернуть все глобально |
| `Ctrl+Shift+→` | Развернуть все глобально |

На листовых задачах (без детей) `←/→` ничего не делают.

### Быстрый поиск

**Поиск по названию (`/`):**
- Нажатие `/` открывает строку поиска внизу экрана: `/search: _`
- По мере ввода фильтруются задачи в реальном времени
- Подходящие задачи отображаются нормально
- Неподходящие задачи приглушаются (dimmed)
- `↑/↓` перемещается только по подходящим задачам
- Показывается счётчик совпадений: `/search: auth  (3 matches)`
- `Esc` или повторный `/` сбрасывает фильтр

**Переход по ID (`g`):**
- Нажатие `g` открывает строку: `go: bd-_`
- Ввод фрагмента ID (например `a1b2`)
- Мгновенный переход при уникальном совпадении (без Enter)
- `Esc` отменяет

**Навигация по результатам:**

| Клавиша | Действие |
|---------|----------|
| `n` | Следующее совпадение |
| `N` | Предыдущее совпадение |

### Task Detail Modal

| Клавиша | Действие |
|---------|----------|
| `Esc` | Закрыть |
| `Tab` | Переключение между кнопками статуса |
| `Enter` | Применить статус |

## Декомпозиция (вертикальные срезы)

### V1. MVP — "Только смотреть"
- Чтение issues.jsonl
- 4 колонки с карточками
- Tab между колонками, ↑/↓ между задачами
- q для выхода

**Результат:** Можно смотреть задачи в терминале

### V2. Интерактивность
- Task Detail Modal (Enter)
- Смена статуса из модалки
- Сохранение в файл

**Результат:** Можно менять статусы

### V3. Иерархия
- Древовидное отображение
- Цепочки предков для детей в других колонках
- Сворачивание (Space, ←/→)
- Ctrl-варианты для массового сворачивания

**Результат:** Удобная работа с большими проектами

### V4. Поиск
- `/` поиск по названию
- `g` переход по ID
- Dimmed + n/N навигация

**Результат:** Быстрый доступ к нужной задаче

### V5. Live updates
- File watcher
- Автообновление UI

**Результат:** Работа в связке с CLI/агентами

## Структура проекта

```
tkbeads/
├── pyproject.toml
├── src/
│   └── tkbeads/
│       ├── __init__.py
│       ├── __main__.py          # Entry point
│       ├── app.py               # TkbeadsApp
│       │
│       ├── data/
│       │   ├── models.py        # Task, Status
│       │   ├── loader.py        # BeadsLoader
│       │   └── watcher.py       # FileWatcher
│       │
│       ├── store/
│       │   └── task_store.py    # TaskStore
│       │
│       ├── ui/
│       │   ├── screens/
│       │   │   └── kanban.py
│       │   ├── widgets/
│       │   │   ├── board.py
│       │   │   └── card.py
│       │   └── modals/
│       │       └── detail.py
│       │
│       └── styles/
│           └── app.tcss
```

## Зависимости

```toml
dependencies = [
    "textual>=0.89",
    "watchfiles>=0.24",
]
```

## Ссылки

- [Beads](https://github.com/steveyegge/beads) — оригинальный трекер
- [beads_viewer](https://github.com/Dicklesworthstone/beads_viewer) — Go TUI (референс)
- [Textual](https://textual.textualize.io/) — TUI-фреймворк
